<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CF-355: Начало</title>
    <style>
    body {
      margin: 0;
      background-color: #000;
      color: #ccc;
      font-family: 'Courier New', monospace;
      overflow: hidden;
    }
    #container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      position: relative;
    }
    #startBtn {
      padding: 1rem 2rem;
      background-color: #111;
      color: #ccc;
      border: 2px solid #ccc;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .slide {
      position: absolute;
      top: 100vh;
      opacity: 0;
      transition: all 0.8s ease-in-out;
      max-width: 600px;
      padding: 20px;
      text-align: center;
      text-shadow: 0 0 1px #888, 0 0 1px #aaa, 0 0 2px #ccc;
    }
    .slide.active {
      top: 50%;
      transform: translateY(-50%);
      opacity: 1;
    }
    .slide.out {
     top: -50%;
     transform: translateY(50%);
     opacity: 1;
    }
  </style>
</head>
<body>
  <div id="container">
    <button id="startBtn">начать</button>
  </div>

  <audio id="ambience1" src="sound/kventa/212025__qubodup__sci-fi-laboratory-ambience.ogg" loop></audio>
  <audio id="music1" src="sound/kventa/The_Prison.mp3" loop></audio>
  <audio id="ambience3" src="sounds/ambience3.mp3" loop></audio>
  <audio id="open1" src="sound/kventa/425090__neospica__pressurized-door-opening.wav"></audio>
  <audio id="open2" src="sound/kventa/90143__pengo_au__steam_burst.wav"></audio>
  <audio id="open3" src="sound/kventa/325269__deleted_user_2104797__body-fall-2.wav"></audio>
  <audio id="open4" src="sound/kventa/195955__minian89__bucket_splash.mp3"></audio>
  <script>
    
    const container = document.getElementById('container');
    const startBtn = document.getElementById('startBtn');

    const audioMap = {
      ambience1: document.getElementById('ambience1'),
      music1: document.getElementById('music1'),
      ambience2: document.getElementById('ambience2'),
      open1: document.getElementById('open1'),
      open2: document.getElementById('open2'),
      open3: document.getElementById('open3'),
      open4: document.getElementById('open4')
    };

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function createFilteredSource(audioElement, type = 'lowpass', freq = 500) {
  const source = audioCtx.createMediaElementSource(audioElement);
  const filter = audioCtx.createBiquadFilter();
  filter.type = type;
  filter.frequency.value = freq;
  const gain = audioCtx.createGain();
  gain.gain.value = 0.5;
  source.connect(filter).connect(gain).connect(audioCtx.destination);
  audioElement._filter = filter;
  audioElement._gain = gain;
  return { filter, gain };
}

const filters = {
  ambience1: createFilteredSource(audioMap.ambience1),
};

    const slides = [
      {
        text: '...',
        play: ['ambience1', 'music1'],
        stop: [],
        filterOn: ['ambience1'],
        fadeIn: { ambience1: 1500, music1: 1500 }
      },
      {
        text: 'Тепло...',
        play: [],
        stop: []
      },
      {
        text: 'Я чувствую, как что-то теплое обволакивает меня с ног до головы.',
        play: [],
        stop: []
      },
      {
        text: '...',
        play: ['open1', 'open2', 'open3', 'open4'],
        stop: [],
        filterOff: ['ambience1']
      },
      {
        text: 'Холодно...',
        play: [],
        stop: []
      },
      {
        text: '<em>Сквозь глухую темноту слышно:</em><br><br>"Сорок семь здоровы... Троих на утилизацию..."',
        play: [],
        stop: []
      },
      {
        text: 'Что это за голос? Кого на утилизацию?',
        play: [],
        stop: []
      },
      {
        text: '"Здоровых отправьте на имплантацию и разделите на группы."',
        play: [],
        stop: [],
        fadeOut: { ambience1: 1200}
      },
    ];

    let currentSlide = -1;
    let readyForClick = false;

    function createSlide(text) {
      const div = document.createElement('div');
      div.classList.add('slide');
      div.innerHTML = text;
      container.appendChild(div);
      return div;
    }

function fadeGain(gainNode, to, duration = 1000, onEnd) {
  const from = gainNode.gain.value;
  const stepTime = 30;
  const steps = Math.ceil(duration / stepTime);
  let currentStep = 0;
  const diff = to - from;
  if (steps <= 0) {
    gainNode.gain.value = to;
    if (onEnd) onEnd();
    return;
  }
  clearInterval(gainNode._fadeTimer);
  gainNode._fadeTimer = setInterval(() => {
    currentStep++;
    gainNode.gain.value = Math.max(0, Math.min(1, from + (diff * currentStep / steps)));
    if (currentStep >= steps) {
      gainNode.gain.value = to;
      clearInterval(gainNode._fadeTimer);
      if (onEnd) onEnd();
    }
  }, stepTime);
}

    function fadeAudio(audio, to, duration = 1000, onEnd) {
  if (audio._gain) {
    fadeGain(audio._gain, to, duration, onEnd);
  } else {
    const stepTime = 30;
    const from = audio.volume;
    const steps = Math.ceil(duration / stepTime);
    let currentStep = 0;
    const diff = to - from;
    if (steps <= 0) {
      audio.volume = to;
      if (onEnd) onEnd();
      return;
    }
    clearInterval(audio._fadeTimer);
    audio._fadeTimer = setInterval(() => {
      currentStep++;
      audio.volume = Math.max(0, Math.min(1, from + (diff * currentStep / steps)));
      if (currentStep >= steps) {
        audio.volume = to;
        clearInterval(audio._fadeTimer);
        if (onEnd) onEnd();
      }
    }, stepTime);
  }
}

    function showNextSlide() {
      if (currentSlide >= 0) {
        slidesElements[currentSlide].classList.remove('active');
        slidesElements[currentSlide].classList.add('out');
      }

      currentSlide++;

      if (currentSlide >= slides.length) return;

      const { play, stop, filterOn = [], filterOff = [], fadeIn = {}, fadeOut = {} } = slides[currentSlide];

      stop.forEach(id => {
        const audio = audioMap[id];
        if (audio) {
          if (fadeOut[id]) {
            fadeAudio(audio, 0, fadeOut[id], () => {
              audio.pause();
              audio.currentTime = 0;
            });
          } else {
            audio.pause();
            audio.currentTime = 0;
            if (audio._gain) audio._gain.gain.value = 0.5;
            else audio.volume = 0.5;
          }
        }
      });

      play.forEach(id => {
        const audio = audioMap[id];
        if (audio) {
          if (fadeIn[id]) {
            if (audio._gain) audio._gain.gain.value = 0;
            else audio.volume = 0;
            audio.play().then(() => {
              fadeAudio(audio, 0.5, fadeIn[id]);
            }).catch(e => console.warn("Autoplay blocked", e));
          } else {
            if (audio._gain) audio._gain.gain.value = 0.5;
            else audio.volume = 0.5;
            audio.play().catch(e => console.warn("Autoplay blocked", e));
          }
        }
      });

      filterOn.forEach(id => {
        const obj = filters[id];
        if (obj && obj.filter) obj.filter.frequency.value = 2000;
      });

      filterOff.forEach(id => {
        const obj = filters[id];
        if (obj && obj.filter) obj.filter.frequency.value = 22000;
      });

      const el = slidesElements[currentSlide];
      el.classList.add('active');
    }

    const slidesElements = slides.map(slide => createSlide(slide.text));

    startBtn.addEventListener('click', () => {
      startBtn.style.display = 'none';
      showNextSlide();
      setTimeout(() => {
        readyForClick = true;
      }, 100);
    });

    container.addEventListener('click', () => {
      if (!readyForClick) return;
      if (currentSlide >= 0 && currentSlide < slides.length - 1) {
        showNextSlide();
      }
    });

  </script>
</body>
</html>
