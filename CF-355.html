<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CF-355: Начало</title>
    <style>
    #particleCanvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      width: 100%;
      height: 100%;
    }

    .interactive-thought {
      color: #ffe066;
      letter-spacing: 0.12em;
      text-shadow:
        0 0 2px #ffe066,
        0 0 6px #ffe06688,
        1px 0 0 #222,
        0 1px 0 #222;
      filter: contrast(1.3) brightness(1.1);
      animation: crtFlicker 0.18s infinite;
    }

    @keyframes crtFlicker {
      0% { opacity: 0.95; }
      50% { opacity: 0.85; }
      100% { opacity: 0.95; }
}

    body, button, a, input, textarea, select {
      cursor: none !important;
    }

    body {
      cursor: none;
    }

    #customCursor {
      position: fixed;
      top: 0;
      left: 0;
      width: 12px;
      height: 12px;
      background-color: white;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      transition: transform 0.1s ease, width 0.2s ease, height 0.2s ease;
    }

    .pointer-hover #customCursor {
      width: 24px;
      height: 24px;
      background-color: white;
      opacity: 0.9;
    }

    body {
      margin: 0;
      background-color: #000;
      color: #ccc;
      font-family: 'Courier New', monospace;
      overflow: hidden;
    }
    #container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      position: relative;
    }
    #startBtn {
      padding: 1rem 2rem;
      background-color: #111;
      color: #ccc;
      border: 2px solid #ccc;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .slide {
      position: absolute;
      top: 100vh;
      opacity: 0;
      transition: all 0.8s ease-in-out;
      max-width: 600px;
      padding: 20px;
      text-align: center;
      text-shadow: 0 0 1px #888, 0 0 1px #aaa, 0 0 2px #ccc;
    }
    .slide.active {
      top: 50%;
      transform: translateY(-50%);
      opacity: 1;
    }
    .slide.out {
     top: -50%;
     transform: translateY(50%);
     opacity: 1;
    }
    .yellow-annot {
      color: #ffe066;
      font-weight: bold;
      border-bottom: 1px dashed #ffe066;
      position: relative;
      transition: color 0.2s;
    }
    .yellow-annot:hover {
      color: #fffbe0;
    }
    .yellow-annot-tooltip {
      display: block;
      visibility: hidden;
      opacity: 0;
      position: absolute;
      left: 50%;
      top: 2.2em;
      transform: translateX(-50%);
      background: rgba(30, 34, 40, 0.98);
      color: #ffe066;
      border-radius: 0;
      border: 1.5px solid #ffe066;
      box-shadow: 0 6px 24px 0 #000a, 0 1.5px 6px 0 #ffe06655;
      padding: 10px 18px;
      font-size: 1em;
      z-index: 2000;
      white-space: pre-line;
      min-width: 320px;
      max-width: 600px;
      pointer-events: auto;
      transition: opacity 0.18s cubic-bezier(.4,2,.6,1), visibility 0.18s cubic-bezier(.4,2,.6,1);
      font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', 'Courier New', monospace;
      font-weight: 500;
      letter-spacing: 0.02em;
      line-height: 1.5;
      text-align: left;
    }
    .yellow-annot:hover .yellow-annot-tooltip,
    .yellow-annot-tooltip:hover {
      visibility: visible;
      opacity: 1;
    }
    .yellow-animated {
      color: #ffe066;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      font-size: 1.1em;
      letter-spacing: 1px;
      margin-top: 0;
      margin-bottom: 0.5em;
      white-space: pre;
      transition: color 0.3s;
      position: fixed;
      top: 1.5em;
      left: 2em;
      text-align: left;
      z-index: 1000;
      pointer-events: none;
    }

    html, body, #container, .slide, .yellow-annot, .yellow-annot-tooltip, .yellow-animated {
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;
    }
  </style>
</head>
<div id="customCursor"></div>
<body>
  <canvas id="particleCanvas"></canvas>

  <div id="container">
    <button id="startBtn">начать</button>
  </div>
  <span id="yellowAnimatedGlobal" class="yellow-animated" style="display:none"></span>

  <audio id="marsTrack" src="sound/kventa/Mars_Special_Track.mp3"></audio>


  <audio id="ambience1" src="sound/kventa/212025__qubodup__sci-fi-laboratory-ambience.ogg" loop></audio>
  <audio id="music1" src="sound/kventa/The_Prison.mp3" loop></audio>
  <audio id="ambience3" src="sounds/ambience3.mp3" loop></audio>

  <audio id="open1" src="sound/kventa/425090__neospica__pressurized-door-opening.wav"></audio>
  <audio id="open2" src="sound/kventa/90143__pengo_au__steam_burst.wav"></audio>
  <audio id="open3" src="sound/kventa/325269__deleted_user_2104797__body-fall-2.wav"></audio>
  <audio id="open4" src="sound/kventa/195955__minian89__bucket_splash.mp3"></audio>

  <audio id="surgery" src="sound/kventa/520222__podcapocalipsis__broken-bone-and-flesh.wav"></audio>

  <audio id="access" src="sound/kventa/459992__florianreichelt__beep-short.mp3"></audio>

  <audio id="writing" src="sound/kventa/33773__digifishmusic__writing.wav"></audio>

  <audio id="click" src="sound/kventa/mixkit-old-camera-shutter-click-1137.wav"></audio>

  <audio id="CF377" src="sound/kventa/CF-377 coming.wav"></audio>

  <audio id="sighwithfx" src="sound/kventa/sighwithfx.wav"></audio>

  <audio id="alarm1" src="sound/kventa/Alarm1.wav"></audio>
  

  <script>

    let analyser, dataArray, marsTrackNode;
    let isMarsEQ = false;

    
    const container = document.getElementById('container');
    const startBtn = document.getElementById('startBtn');

    const audioMap = {
      ambience1: document.getElementById('ambience1'),
      music1: document.getElementById('music1'),
      ambience2: document.getElementById('ambience2'),

      open1: document.getElementById('open1'),
      open2: document.getElementById('open2'),
      open3: document.getElementById('open3'),
      open4: document.getElementById('open4'),

      surgery: document.getElementById('surgery'),

      access: document.getElementById('access'),

      writing: document.getElementById('writing'),

      click: document.getElementById('click'),

      marsTrack: document.getElementById('marsTrack'),

      CF377: document.getElementById('CF377'),

      sighwithfx: document.getElementById('sighwithfx'),

      alarm1: document.getElementById('alarm1')
    };

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function createFilteredSource(audioElement, type = 'lowpass', freq = 500) {
  const source = audioCtx.createMediaElementSource(audioElement);
  const filter = audioCtx.createBiquadFilter();
  filter.type = type;
  filter.frequency.value = freq;
  source.connect(filter).connect(audioCtx.destination);
  return filter;
}

const filters = {
  ambience1: createFilteredSource(audioMap.ambience1),

};

    const slides = [

      {
        text: '...',
        play: ['ambience1', 'music1', 'click'],
        stop: [],
        thoughts: [
      { text: "Моя первая мысль", minLinks: 1, removeBelow: 1,},
      { text: "Где я?", minLinks: 6, removeBelow: 4 },
      { text: "Ощущения приятные", minLinks: 6, removeBelow: 4 },
      { text: "Я плаваю?", minLinks: 4, removeBelow: 2},
        ],
        filterOn: ['ambience1']
      },
      {
        text: '...',
        play: ['ambience1', 'music1', 'click'],
        stop: [],
        thoughts: [
      { text: "Моя первая мысль", minLinks: 1, removeBelow: 1,},
      { text: "Где я?", minLinks: 6, removeBelow: 4 },
      { text: "Ощущения приятные", minLinks: 6, removeBelow: 4 },
      { text: "Я плаваю?", minLinks: 4, removeBelow: 2},
        ],
        filterOn: ['ambience1']
      },
      {
        text: 'Тепло...',
        play: ['click'],
        stop: []
      },
      {
        text: 'Я чувствую, как что-то теплое обволакивает меня с ног до головы.',
        play: ['click'],
        stop: [],
        thoughts:[
      { text: "Нос чешется", minLinks: 4, removeBelow: 2 },
      { text: "Тепло, приятно...", minLinks: 6, removeBelow: 4 },
      { text: "Вот бы это продолжалось вечно", minLinks: 6, removeBelow: 4 },
      { text: "Что это там пикает?", minLinks: 4, removeBelow: 2 },
      ]
      },
      {
        text: '...',
        play: ['open1', 'open2', 'open3', 'open4', 'click'],
        stop: [],
        filterOff: ['ambience1'],
        thoughts:[
      { text: "Нееет...", minLinks: 4, removeBelow: 2 },
      { text: "Я хочу обратно", minLinks: 6, removeBelow: 4 },
      { text: "Неприятно, холодно", minLinks: 6, removeBelow: 4 },
      { text: "Пахнет какой-то химией", minLinks: 4, removeBelow: 2 },
      ]
      },
      {
        text: 'Холодно...',
        play: ['click'],
        stop: []
      },
      {
        text: '<em>Сквозь глухую темноту слышно:</em><br><br>"Сорок семь здоровы... Троих на утилизацию..."',
        play: ['click'],
        stop: []
      },
      {
        text: 'Что это за голос? Кого на утилизацию?',
        play: ['click'],
        stop: []
      },
      {
        text: '"Здоровых отправьте на имплантацию и разделите на группы."',
        play: ['click'],
        stop: []
      },
      {
        text: 'Я чувствую отдалённые прикосновения, затем ощущения затихают...',
        play: ['click'],
        stop: []
      },
      {
        text: '...',
        play: ['surgery', 'click'],
        stop: []
      },
      {
        text: '...',
        yellowAnimated: [
          {
            text: "connecting the neural interface",
            dots: true,
            final: "---[neural interface connected]---",
            play: [], 
            endPlay: ["access"] 
          },
          {
            text: "cognitive support activation",
            dots: true,
            final: "---[cognitive support is live]---",
            play: [],
            endPlay: ["access"]
          }
        ],
        play: ['click'],
        stop: []
      },
      {
        text: '...',
        play: ['click'],
        stop: []
      },
      {
        text: 'Сколько времени прошло?',
        play: ['click'],
        stop: ['ambience1']
      },
      {
        text: '<em>Яркий свет. Ослепительный свет. ...Фонарик?</em>"',
        play: ['click'],
        stop: []
      },
      {
        text: '<em>Я проморгалась и прищурилась, смотря перед собой</em><br><br>Передо мной стоит мужчина в белом халате. Он убрал фонарик в карман и записал что-то в планшет.',
        play: ['writing', 'click'],
        stop: []
      },
      {
        text: '"Она в сознании..."<br><br>Мужчина отдал планшет девушке и вышел из комнаты',
        play: ['click'],
        stop: []
      },
      {
        text: 'Девушка смотрит в планшет, затем кладет его на стол и садится на стул напротив меня и слегка улыбается.<br><br>"С пробуждением. Понимаешь меня? Говорить умеешь?"',
        play: ['click'],
        stop: []
      },
      {
        text: 'Почему все ощущается так странно..? <br><em>Я смотрю на девушку передо мной.</em> Она одета в синюю униформу. у нее аккуратно постриженные черные волосы на уровне плеч. Она мягко улыбается мне. Я чувствую себя комфортно рядом с ней. Нужно ей ответить...<br><br>"Да... Кажется умею..."',
        play: ['click'],
        stop: []
      },
      {
        text: 'Девушка подняла два больших пальца вверх и кивнула.<br><br>"Меня зовут Алиса. Я помогу тебе освоиться."',
        play: ['click'],
        stop: []
      },
      {
        text: 'Она сложила руки<br><br>"Для начала. Ты репликант. Искуственно созданный человек. Прямо сейчас мы находимся в системе [[Никс|Твое место дислокации. Важнейшая система в пределах пространства ОСЧ на данный момент.]]. Твой номер - CF-355"',
        play: ['click'],
        stop: []
      },
      {
        text: 'Стоп. Это кажется знакомым.<br><br> "Кажется... Я откуда-то уже знаю про систему Никс."',
        play: ['click'],
        stop: []
      },
      {
        text: 'Алиса постучала пальцем по своей голове. <br><br>"Имплант. Он подсказывает тебе. Он позволит тебе быстрее обучаться, а также поможет справляться с эмоциями."',
        play: ['click'],
        stop: []
      },
      {
        text: 'Она посмотрела на меня с некоторым сожалением... Но почему?<br>Она вернула свое прежнее выражение лица и продолжила:<br><br>"Ты сейчас находишься на борту корабля [[Телхин|Флагман ОСЧ. Оснащен тяжелой артиллерией. Также корабль выступает в качестве ремонтной станции, а также собирает легкие корабли, готовые к бою.]]" ',
        play: ['click'],
        stop: []
      },
      {
        text: '"Прямо сейчас Телхин участвует в бою. Мы находимся в тылу и подготавливаем таких как ты для управления штурмовиками. Через месяц ты вылетаешь в бой."',
        play: ['click'],
        stop: []
      },
      {
        text: 'Вот оно как...<br>Алиса смотрит на меня, пытаясь понять мою реакцию. Замечая, что я спокойна, она кивает и продолжает<br><br>"Твоё обучение скоро начнётся. Через час тебе нужно подойти в класс 45, а пока можешь сходить поесть."',
        play: ['click'],
        stop: []
      },
      {
        text: '"Сейчас мы находимся в отдельной зоне, где происходит создание и обучение репликантов. Ну и жить пока ты будешь тоже тут. У тебя есть доступ в общую зону для перосонала, так что тебе не обязательно сидеть в нашей зоне постоянно."',
        play: ['click'],
        stop: []
      },
      {
        text: '<em>Некоторое время спустя я вышла в коридор общей зоны</em><br>Идя по коридору я видела людей. Многие спешили куда-то. Кажется офицер шел по коридору впереди. Рядом находящиеся члены экипажа отдавали ему честь. В этом жесте не было энтузиазма. Лишь заученное до рефлекса механическое движение. Сам офицер никак не реагировал и просто шел дальше.',
        play: ['click'],
        stop: []
      },
      {
        text: 'Все вокруг выглядят такими подавленными. Я не знаю стоит ли мне заводить разговор с кем-то...',
        play: ['click'],
        stop: []
      },
      {
        text: 'Проходя очередной шлюз, я обнаружила по правую сторону коридора окно, выходящее на широкий ангар.',
        play: ['click'],
        stop: []
      },
      {
        text: 'В ангаре кипела работа. Десятки человек занимались тем, что принимали в ангаре разбитые корабли. Из них доставали тела погибших и раненых. Тут же происходил и ремонт кораблей, если они еще подлежали восстановлению.',
        play: ['click'],
        stop: []
      },
      {
        text: 'Я засмотрелась на это, продолжая идти по коридору и вдруг в кого-то врезалась.',
        play: ['click'],
        stop: []
      },
      {
        text: 'Я повернула голову и увидела перед собой инженера, который уронил на пол инструменты после столкновения со мной. Он посмотрел на меня со злобой и презрением.',
        play: ['click'],
        stop: []
      },
      {
        text: '"Ой, извините, я..."<br>Не успела я договорить, как он резко пнул меня под коленом. Удар лицом о стальной пол, тошнотворные ощущения от разбитого носа.',
        play: ['click'],
        stop: [],
        thoughts:[
      { text: "Больно!", minLinks: 4, removeBelow: 2 },
      { text: "За что?", minLinks: 6, removeBelow: 4 },
      { text: "Кровь пошла", minLinks: 6, removeBelow: 4 },
      { text: "ой-ой-ой...", minLinks: 4, removeBelow: 2 },
      ]
        
      },
      {
        text: '"Да пошла ты нахуй, сука!"<br>Затем стальной нос его ботинка врезался в мой бок. Какая ужасная боль...',
        play: ['click'],
        stop: []
      },
      {
        text: 'Еще несколько ударов... Я закрыла область живота левой рукой, а правой зажала нос из которого лилась кровь.',
        play: ['click'],
        stop: []
      },
      {
        text: 'Через некоторыое время удары прекратились и он ушел, но я продолжала лежать на полу, чувствуя вкус крови у себя во рту.',
        play: ['click'],
        stop: []
      },
      {
        text: 'Кажется, сзади кто-то подходит ко мне...',
        play: ['click', 'CF377'],
        stop: [],
        thoughts:[
      { text: "Больно...", minLinks: 4, removeBelow: 2 },
      { text: "Шаги приближаются", minLinks: 6, removeBelow: 4 },
      { text: "Кто это?", minLinks: 6, removeBelow: 4 },
      { text: "Тошнит", minLinks: 4, removeBelow: 2 },
      ]
      },
      {
        text: 'Кто-то берет меня под руку и начинает поднимать с пола. Теперь я вижу - это черноволосая девушка с янтарными глазами. Она одета так же, как и я. На ее форме номер: RT-381.',
        play: ['click', 'sighwithfx'],
        stop: [],
        thoughts:[
      { text: "381...", minLinks: 4, removeBelow: 2 },
      { text: "Спасибо", minLinks: 6, removeBelow: 4 },
      { text: "Кровь все еще течет...", minLinks: 6, removeBelow: 4 },
      { text: "Значит она тоже...", minLinks: 4, removeBelow: 2 },
      ]
      },
      {
        text: '"Зажми нос и наклони голову вперед."<br>Держа меня под руку, она повела меня куда-то.',
        play: ['click'],
        stop: [],
        thoughts:[
      { text: "Ага... Поняла", minLinks: 4, removeBelow: 2 },
      { text: "Живот болит", minLinks: 4, removeBelow: 2 },
      ]
      },
      {
        text: 'Мы дошли до шлюза. Она приложила к нему свою руку и он открылся. Кажется это был туалет.<br>"Не переживай, ты не виновата."<br>Мы подошли к раковине, она включила кран и начала мыть мое лицо. Вода вперемешку с кровью стекали по стенкам раковины.',
        play: ['click'],
        stop: [],
        thoughts:[
      { text: "Кровь", minLinks: 4, removeBelow: 2 },
      { text: "Вода прохладная", minLinks: 4, removeBelow: 2 },
      { text: "Да, я не виновата...", minLinks: 6, removeBelow: 3 },
      { text: "Кажется, крови стало поменьше", minLinks: 6, removeBelow: 3 },
      ]
      },
      {
        text: '"Ну вот, как новенькая."<br>Она перекрыла кран и после этого, я подняла взгляд, посмотрев в зеркало.',
        play: ['click'],
        stop: [],
        thoughts:[
      { text: "Так вот, как я выгляжу...", minLinks: 4, removeBelow: 2 },
      { text: "У нас с ней глаза одинакового цвета", minLinks: 4, removeBelow: 2 },
      { text: "Кровь прошла", minLinks: 6, removeBelow: 3 },
      { text: "Я выгляжу паршиво", minLinks: 6, removeBelow: 3 },
      { text: "Ну привет, Я", minLinks: 6, removeBelow: 3 },
      ]
      },
      {
        text: 'Я вздохнула и слегка улыбнулась, глядя на ее отражение.<br>- Спасибо, что помогла.',
        play: ['click'],
        stop: [],
        thoughts:[
      { text: "Все еще больно, но уже лучше", minLinks: 4, removeBelow: 2 },
      { text: "Кажется она тоже будующий пилот", minLinks: 4, removeBelow: 2 },
      { text: "Может мы подружимся", minLinks: 6, removeBelow: 3 },
      { text: "Я выгляжу паршиво", minLinks: 6, removeBelow: 3 },
      { text: "И... Как мне реагировать на то, что она не улыбается в ответ?", minLinks: 6, removeBelow: 3 },
      ]
      },
      {
        text: 'Я развернулась и попыталась сделать шаг, но в этот момент казалось бы утихшая боль в боку ударила с новой силой и я чуть не сложилась.<br>RT-381 Подставила руку и я оперлась на нее.',
        play: ['click'],
        stop: [],
        thoughts:[
      { text: "Какой ужас...", minLinks: 4, removeBelow: 2 },
      { text: "Больно!", minLinks: 4, removeBelow: 2 },
      { text: "Я точно в порядке?", minLinks: 6, removeBelow: 3 },
      { text: "Ходить будет больно...", minLinks: 6, removeBelow: 3 },
      { text: "Сейчас стою смирно... Вроде боль проходит", minLinks: 6, removeBelow: 3 },
      ]
      },
      {
        text: '"Я помогу тебе дойти до класса. Идем."<br>Она взяла меня под руку и повела. Живот все еще болел, но идти стало легче.',
        play: ['click'],
        stop: [],
        thoughts:[
      { text: "Она такая добрая", minLinks: 4, removeBelow: 2 },
      { text: "Класс 45 вроде", minLinks: 4, removeBelow: 2 },
      ]
      },
      {
        text: 'Пройдя через коридоры общей зоны, мы вернулись в зону для репликантов. Это заняло чуть больше времени, поскольку мне было достаточно больно идти. Черт, я ведь так и не поела.',
        play: ['click'],
        stop: [],
      },
      {
        text: 'На входе нас встретил мужчина с надписью "INSTRUCTOR" на форме. Он посмотрел на нас.<br>"Вы уже в паре?"',
        play: ['click'],
        stop: [],
      },
      {
        text: '"Так точно."<br>RT-381 Коротко кивнула и помогла мне войти в класс. Внутри было довольно много других репликантов. И, кажется, у всех были янтарные глаза... Интересно.',
        play: ['click'],
        stop: [],
      },
      {
        text: 'Мы сели на свободные места в переднем ряду. Класс по своей сути состоит из стульев и экрана.',
        play: ['click'],
        stop: [],
      },
      {
        text: 'Инструктор посмотрел на часы, затем оглядел присутствующих.<br>"Для начала - называйте меня инструктор или сэр. Никак иначе."',
        play: ['click'],
        stop: [],
      },
      {
        text: 'Он встал из-за стола и нажал переключатель рядом с экраном. Экран включился и на нем открылась картинка.<br>"Это - стратегическая карта человеческого сектора галактики."',
        play: ['click'],
        stop: [],
      },
      {
        text: '"Вы могли заметить, что большая часть секторов на этой карте отмечены красным цветом."<br>Он указал в верхнюю часть карты, которая была сплошь красной.<br>"Красный - значет окупирован врагом."',
        play: ['click'],
        stop: [],
      },
      {
        text: '<em>Стоп... То есть почти все человеческие секторы были захвачены?</em><br>Я уставилась на карту. Инструктор выдержал паузу и тыкнул пальцем в одну из красных точек.<br>"Вот тут была наша столица. Марс. До тех пор, пока эти твари не уничтожили ее."',
        play: ['click'],
        stop: [],
      },
      {
        text: 'Инструктор вздохнул, убрал руку с карты и продолжил.<br>"Враг думал, что это сломит нас. Что заставит нас капитулировать. Но человечество не должно сдаваться. Инопланетные захватчики должны пожалеть о том, что посмели напасть на нас."',
        play: ['click'],
        stop: [],
      },
      {
        text: '"Вот тут..."<br>Он снова повернулся к карте и указал пальцем на белую точку в нижней части рядом с окупированными территориями.<br>""...находимся мы. Главные силы ОСЧ. Здесь мы принимаем бой. И этот бой решает судьбу человечества. Система, в которой мы находимся - является ключевой. Тут сконцентрированны главные ресурсные и промышленные силы ОСЧ. Враг направил сюда свой сильнейший флот. И мы прямо сейчас отбиваем его атаку."',
        play: ['click'],
        stop: [],
      },
      {
        text: 'Инструктор развернулся к нам.<br>"Если Объединенные Силы Человечества смогут отбить эту атаку - это сможет задержать и так уже истащённого врага и дать человечеству время на подготовку к контратаке, но если мы потеряем Никс, то у человечества уже не будет шансов. Мы лишимсся наших главных ресурсов и поражение будет лишь вопросом времени... По этому мы должны показать врагу ад. Мы должны сделать все, для того, чтобы отбить эту атаку. И если мы сможем - это будет первой победой человечества, которая положит начало освобождению от гнёта захватчика."',
        play: ['click'],
        stop: [],
      },
      {
        text: '"Вы тоже внесете свой вклад в бой..."',
        play: ['click'],
        stop: [],
      },
      {
        text: 'Я прикрываю глаза. Как много всего произошло за пару часов...',
        play: ['click'],
        stop: [],
        thoughts: [
          { text: "Инструктор говворил...", minLinks: 4, removeBelow: 2 },
          { text: "Про что он там говорил?", minLinks: 4, removeBelow: 2 },
          { text: "Про инструктаж...", minLinks: 4, removeBelow: 2 },
          { text: "У него приятный голос...", minLinks: 6, removeBelow: 4 },
        ]
      },
      {
        text: 'Внезапная резкая боль в боку заставляет меня открыть глаза.',
        play: ['click'],
        stop: [],
        thoughts: [
          { text: "Больно!", minLinks: 4, removeBelow: 2 },
          { text: "Опять бьют", minLinks: 4, removeBelow: 2 },
          { text: "Может я это заслужила?", minLinks: 4, removeBelow: 2 },
        ]
      },
      {
        text: 'Проморгавшись я вижу перед собой девушку с янтарными глазами. Кажется она чем-то недовольна и снова пихает меня в бок...',
        play: ['click'],
        stop: [],
        thoughts: [
          { text: "А, это она", minLinks: 4, removeBelow: 2 },
          { text: "Хватит бить, дура. Больно", minLinks: 4, removeBelow: 2 },
          { text: "Какая же она злая", minLinks: 4, removeBelow: 2 },
          { text: "Ладно, я заслужила", minLinks: 4, removeBelow: 2 },
        ]
      },
      {
        text: 'Смирив меня строгим взглядом, RK-381 кивнула перед собой. Я посмотрела вперед.',
        play: ['click'],
        stop: [],
        thoughts: [
          { text: "Точно... Инструктаж", minLinks: 4, removeBelow: 2 },
          { text: "Я все пропустила уже?", minLinks: 4, removeBelow: 2 },
          { text: "А про что нам говорили?", minLinks: 4, removeBelow: 2 },
          
        ]
      },
      {
        text: 'Смирив меня строгим взглядом, RK-381 кивнула перед собой. Я посмотрела вперед.',
        play: ['click'],
        stop: [],
        thoughts: [
          { text: "Точно... Инструктаж", minLinks: 4, removeBelow: 2 },
          { text: "Я все пропустила уже?", minLinks: 4, removeBelow: 2 },
          { text: "А про что нам говорили?", minLinks: 4, removeBelow: 2 },
        ]
      },
      {
        text: 'Экран был уже выкоючен.<br>"Это далеко не все, что вам нужно знать. Остальное вы узнаете на следующих инструктажах."',
        play: ['click'],
        stop: [],
        thoughts: [
          { text: "Я действительно все пропустила...", minLinks: 4, removeBelow: 2 },
          { text: "Тут не было ничего важного, наверное", minLinks: 4, removeBelow: 2 },
        ]
      },
      {
        text: 'День за днем мы проходили тоскливые инструктажи...',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Теперь я была более внимательной идя по коридорам. Несколько раз я снова видела того инженера. Больше он на меня внимания не обращал.',
        play: ['click'],
        stop: [],
        thoughts: [
          { text: "Он лаже не извинился", minLinks: 4, removeBelow: 2 },
          { text: "Вот бы его отпиздить!", minLinks: 1, removeBelow: 1 },
        ]
      },
      {
        text: 'Среди всех, кого я тут видела - Алиса казалась самой доброй. Как будто ей не место на этом корабле. Остальной экипаж относился к репликантам в лучшем случае безразлично.',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Каждый день мы проходили инструктажи и всевозможные курсы. Некоторые курсы были весьма даже интересными, но инструктажи... На них я иногда засыпала.',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'После занятий мы с RK-381 возвращались в каюту. Каюта была совсем маленькой. Настолько, что протиснуться в нее мы могли только по очереди.',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Но кроме нас в каюте никого не было и моя соседка была настолько тихой и незаметной, что казалось, будто я живу одна...',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Мы так много проводим времени вместе, но до сих пор толком ничего друг о друге не знаем. Так что я решила сделать первый шаг.',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'RK-381 буднично занимается своим макияжем перед зеркалом. Она это делает каждое утро.',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '"Как жизнь?"',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Отражение RK резко зыркнуло на меня, приподнимая бровь, которую она подводила. Она молчит...',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Как-то неловко получается... Может сразу к делу?<br>"Ну... В общем... Мы толком и не знакомились..."',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '"А о чем нам с тобой говорить? Может о нашем прошлом?"<br>В сравнении с ее лицом, обшивка каюты выглядит более доброжелательной.',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '<em>Блин, точно... И о чем мне ее спросить...</em><br>Мой взгляд цепляется за тушь в ее руке.<br>"Почему ты красишься? И откуда вообще у тебя косметика?"',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '"Досталась от Алисы. Мне было интересно почему у нее такие выразительные глаза. Она ответила, что и мне можно такие сделать... Показала как краситься и оставила немного косметики. Хоть какой-то смысл есть вставать пораньше"',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '"Ну а ты чем занята помимо крепкого сна на инструктажах?"<br>Она сделала небольшую паузу, затем отвечает на свой вопрос:<br>"Ничем."',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '<em>Она меня пристыдить сейчас пытается?</em><br>"Ну вообще-то я... я... "<br>Ничего дельного на ум не приходит... Мой взгляд бегает по каюте, пытаясь зацепиться за что-то.',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Но взгляд не цепляется ни за что кроме RK и ее разочарованного взгляда в отражении зеркала.<br><em>Нужно быстрее придумать что ответить...</em>',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '"А я думаю много!"',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Наконец RK поворачивается ко мне лицом, полным искреннего удивления.',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '...',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: '"Ясно"',
        play: ['click'],
        stop: [],
        thoughts: [
        ]
      },
      {
        text: 'Этот позор был прерван звуковым сигналом, оповещающим о скором начале занятий.',
        play: ['click', 'alarm1'],
        stop: [],
        thoughts: [
        ]
      },
    ];
    let currentSlide = -1;
    let readyForClick = false;
    let yellowAnimationActive = false;

    function renderAnnotatedText(text) {
      if (!text) return '';
      return text.replace(/\[\[([^\|\]]+)\|([^\]]+)\]\]/g, (m, word, info) => {
        return `<span class="yellow-annot">${word}<span class="yellow-annot-tooltip">${info}</span></span>`;
      });
    }

    function createSlide(slide) {
      const div = document.createElement('div');
      div.classList.add('slide');
      if (slide.text) {
        const textDiv = document.createElement('div');
        textDiv.innerHTML = renderAnnotatedText(slide.text);
        div.appendChild(textDiv);
      }
      if (slide.yellowAnimated) {
        div._yellowAnimated = Array.isArray(slide.yellowAnimated)
          ? slide.yellowAnimated.map(obj => ({ ...obj }))
          : [{ ...slide.yellowAnimated }];
      }
      container.appendChild(div);
      return div;
    }

    function showNextSlide() {
      if (currentSlide >= 0) {
        slidesElements[currentSlide].classList.remove('active');
        slidesElements[currentSlide].classList.add('out');
      }

      currentSlide++;

      if (currentSlide >= slides.length) return;

      interactiveThoughtWasAlive = false;
      const slide = slides[currentSlide];
      const { play, stop, filterOn = [], filterOff = [], clickblock = false } = slide;

      stop?.forEach(id => {
        const audio = audioMap[id];
        if (audio) {
          audio.pause();
          try {
            audio.currentTime = 0;
            if (audio.loop) {
              audio.loop = false;
              setTimeout(() => { audio.loop = true; }, 100);
            }
          } catch (e) {}
        }
      });

      play?.forEach(id => {
        const audio = audioMap[id];
        if (audio) {
          audio.volume = audioVolumes[id] !== undefined ? audioVolumes[id] : 0.5;
          audio.play().catch(e => console.warn("Autoplay blocked", e));
        }
      });

      filterOn?.forEach(id => {
        const filter = filters[id];
        if (filter) filter.frequency.value = 2000;
      });

      filterOff?.forEach(id => {
        const filter = filters[id];
        if (filter) filter.frequency.value = 22000;
      });

      blockAdvanceByClickblock = !!clickblock;

      const el = slidesElements[currentSlide];
      el.classList.add('active');
      resetParticleHomes();


      const yellowGlobal = document.getElementById('yellowAnimatedGlobal');
      yellowGlobal.style.display = 'none';
      yellowAnimationActive = false;

      if (el._yellowAnimated && el._yellowAnimated.length > 0) {
        yellowAnimationActive = true;
        animateYellowTextSequence(el._yellowAnimated, () => {
          yellowAnimationActive = false;
        });
      } else {
        yellowGlobal.style.display = 'none';
      }

      if (slide.thoughts && slide.thoughts.some(t => t.interactive)) {
        blockAdvanceByInteractive = true;
      } else {
        blockAdvanceByInteractive = false;
      }
    }

    function triggerNegativeEffect() {
      document.body.classList.add('negative-effect-animate');
      setTimeout(() => {
        document.body.classList.remove('negative-effect-animate');
        document.body.classList.add('negative-effect');
      }, 500);
    }

    function animateYellowTextSequence(sequence, onFinish) {
      const yellowGlobal = document.getElementById('yellowAnimatedGlobal');
      let idx = 0;
      function next() {
        if (idx >= sequence.length) {
          yellowGlobal.style.display = 'none';
          if (typeof onFinish === 'function') onFinish();
          return;
        }
        yellowGlobal.style.display = '';
        animateYellowTextGlobal(sequence[idx], () => {
          idx++;
          next();
        });
      }
      next();
    }

    function animateYellowTextGlobal({ text, dots, final, play = [], endPlay = [] }, onFinish) {
      const yellowGlobal = document.getElementById('yellowAnimatedGlobal');
      let dotCount = 0;
      let maxDots = 3;
      let interval;
      yellowGlobal.style.display = '';
      yellowGlobal.textContent = text + (dots ? '.' : '');

      play.forEach(id => {
        const audio = audioMap[id];
        if (audio) {
          audio.volume = audioVolumes[id] !== undefined ? audioVolumes[id] : 0.5;
          audio.play().catch(e => {});
        }
      });

      if (dots) {
        interval = setInterval(() => {
          dotCount = (dotCount + 1) % (maxDots + 1);
          yellowGlobal.textContent = text + '.'.repeat(dotCount);
        }, 400);
      }
      setTimeout(() => {
        if (interval) clearInterval(interval);
        yellowGlobal.textContent = final;

        endPlay.forEach(id => {
          const audio = audioMap[id];
          if (audio) {
            audio.volume = audioVolumes[id] !== undefined ? audioVolumes[id] : 0.5;
            audio.play().catch(e => {});
          }
        });

        setTimeout(() => {
          if (typeof onFinish === 'function') onFinish();
        }, 700);
      }, 3000);
    }

    const slidesElements = slides.map(slide => createSlide(slide));

      startBtn.addEventListener('click', async () => {
      await audioCtx.resume().catch(e => console.warn("AudioContext resume error:", e));
      startBtn.style.display = 'none';
      showNextSlide();
      setTimeout(() => {
        readyForClick = true;
      }, 100);
    });

    container.addEventListener('click', () => {
      if (!readyForClick) return;
      if (yellowAnimationActive) return;
      if (blockAdvanceUntilCF377Ends) return;
      if (blockAdvanceUntilInteractiveCleared) return;
      if (blockAdvanceByClickblock) return;
      if (currentSlide >= 0 && currentSlide < slides.length - 1) {
        showNextSlide();
      }
    });

    const audioVolumes = {
      ambience1: 0.5,
      music1: 0.2,
      ambience2: 0.5,
      ambience3: 0.5,
      open1: 0.5,
      open2: 0.5,
      open3: 0.5,
      open4: 0.5,
      surgery: 1,
      access: 0.1,
      CF377: 1
    };

    const style = document.createElement('style');
    style.textContent = `
      body.negative-effect {
        filter: invert(1) hue-rotate(180deg) contrast(1.2) brightness(1.1);
        background: #fff !important;
        color: #000 !important;
        transition: filter 0.5s cubic-bezier(.4,2,.6,1), background 0.5s, color 0.5s;
      }
      body.negative-effect-animate {
        animation: negative-flash 0.5s cubic-bezier(.4,2,.6,1);
      }
      @keyframes negative-flash {
        0% { filter: none; background: #000; color: #ccc; }
        100% { filter: invert(1) hue-rotate(180deg) contrast(1.2) brightness(1.1); background: #fff; color: #000;}
      }
    `;
    document.head.appendChild(style);

      const cursor = document.getElementById('customCursor');

  document.addEventListener('mousemove', (e) => {
    cursor.style.left = e.clientX + 'px';
    cursor.style.top = e.clientY + 'px';
  });

  document.addEventListener('mouseover', (e) => {
    if (e.target.closest('button, a, .clickable')) {
      document.body.classList.add('pointer-hover');
    }
  });

  document.addEventListener('mouseout', (e) => {
    if (e.target.closest('button, a, .clickable')) {
      document.body.classList.remove('pointer-hover');
    }
  });
  </script>
  <script>
  const canvas = document.getElementById("particleCanvas");
  const ctx = canvas.getContext("2d");
  let particles = [];
  const particleCount = 100;
  let mouse = { x: null, y: null };

  const LINK_DISTANCE = 60;
  const LINK_BREAK_DISTANCE = 120;
  const LINK_TIME = 1000;
  const LINK_FORCE = 0.0010;

  let links = [];
  let linkMap = new Map();

  function pairKey(a, b) {
    return a.id < b.id ? `${a.id}|${b.id}` : `${b.id}|${a.id}`;
  }

  const LINK_UPDATE_PERIOD = 2;
  const CLUSTER_UPDATE_PERIOD = 6;
  let frameCount = 0;
  let activeRects = [];
  let breakingLinks = [];
  if (linkMap && linkMap.clear) linkMap.clear();

  let activeThoughts = [];
  let thoughtTemplates = [];
  const CLUSTER_RADIUS = 48;
  const CLUSTER_MATCH_RADIUS = 50;
  let nextThoughtId = 1;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    particles.forEach(p => {
      p.homeX = Math.random() * canvas.width;
      p.homeY = Math.random() * canvas.height;
      if (p.x > canvas.width) p.x = p.homeX;
      if (p.y > canvas.height) p.y = p.homeY;
    });
  }

  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  document.addEventListener("mousemove", e => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
  });

  class Particle {
    constructor() {
      this.homeX = Math.random() * canvas.width;
      this.homeY = Math.random() * canvas.height;
      this.x = this.homeX;
      this.y = this.homeY;
      this.vx = (Math.random() - 0.2) * 0.2;
      this.vy = (Math.random() - 0.2) * 0.2;
      this.size = Math.random() * 2 + 1;
      this.baseAlpha = Math.random() * 0.4 + 0.4;
      this.alphaOffset = Math.random() * Math.PI * 2;
      this.wanderAngle = Math.random() * Math.PI * 2;
      this.id = Particle._id++;
      this.nearTimes = {};
    }

    update(time) {
      let dxHome = this.homeX - this.x;
      let dyHome = this.homeY - this.y;
      this.vx += dxHome * 0.0003;
      this.vy += dyHome * 0.0003;

      this.wanderAngle += (Math.random() - 0.5) * 0.05;
      this.vx += Math.cos(this.wanderAngle) * 0.02;
      this.vy += Math.sin(this.wanderAngle) * 0.02;

      let dx = this.x - mouse.x;
      let dy = this.y - mouse.y;
      let dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 100) {
        this.vx += dx / dist * 0.08;
        this.vy += dy / dist * 0.08;
      }

      for (const link of links) {
        let other = null;
        if (link.a === this) other = link.b;
        else if (link.b === this) other = link.a;
        if (other) {
          let dxl = other.x - this.x;
          let dyl = other.y - this.y;
          let d = Math.sqrt(dxl * dxl + dyl * dyl) || 1;
          this.vx += dxl / d * LINK_FORCE;
          this.vy += dyl / d * LINK_FORCE;
        }
      }

      this.x += this.vx;
      this.y += this.vy;

      this.vx *= 0.94;
      this.vy *= 0.94;

      this.alpha = this.baseAlpha + Math.sin(time / 1000 + this.alphaOffset) * 0.2;
    }

    getOpacity() {
  let opacity = this.alpha;
  if (!activeRects || activeRects.length === 0) return Math.max(0, Math.min(1, opacity));
  for (const rect of activeRects) {
    const cx = this.x, cy = this.y;
    const dx = Math.max(rect.left - cx, 0, cx - rect.right);
    const dy = Math.max(rect.top - cy, 0, cy - rect.bottom);
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist < 120) {
      opacity *= dist / 120;
    }
  }
  return Math.max(0, Math.min(1, opacity));
}

    draw() {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      const alpha = this.getOpacity() * (this.eqAlpha !== undefined ? this.eqAlpha : 1);
      ctx.fillStyle = `rgba(255,255,255,${alpha})`;
      ctx.fill();
    }
  }

  Particle._id = 0;

  for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
  }

  function updateLinks(time) {
    const LINK_DIST2 = LINK_DISTANCE * LINK_DISTANCE;
    const LINK_BREAK2 = LINK_BREAK_DISTANCE * LINK_BREAK_DISTANCE;

    for (let i = 0; i < particles.length; i++) {
      const a = particles[i];
      for (let j = i + 1; j < particles.length; j++) {
        const b = particles[j];
        const dx = a.x - b.x, dy = a.y - b.y;
        const dist2 = dx * dx + dy * dy;
        const key = pairKey(a, b);
        const existing = linkMap.get(key);

        if (dist2 < LINK_DIST2) {
          if (!a.nearTimes[b.id]) a.nearTimes[b.id] = time;
          if (!b.nearTimes[a.id]) b.nearTimes[a.id] = time;
          const nearTime = Math.max(a.nearTimes[b.id], b.nearTimes[a.id]);
          if (!existing && (time - nearTime > LINK_TIME)) {
            linkMap.set(key, { a, b, created: time, progress: 0, eqAlpha: 1 });
          }
        } else {
          a.nearTimes[b.id] = time;
          b.nearTimes[a.id] = time;
        }

        const link = linkMap.get(key);
        if (link && dist2 > LINK_BREAK2) {
          linkMap.delete(key);
          breakingLinks.push({ ...link, progress: link.progress || 1 });
        }
      }
    }

    for (const [k, l] of linkMap.entries()) {
      if (!particles.includes(l.a) || !particles.includes(l.b)) linkMap.delete(k);
    }
  }

  function drawLinks() {
    ctx.save();
    ctx.lineWidth = 1.1;

    for (const link of linkMap.values()) {
      if (link.progress < 1) link.progress += 0.08;
      if (link.progress > 1) link.progress = 1;

      const { a, b, progress } = link;
      const eqAlpha = (link.eqAlpha === undefined) ? 1 : link.eqAlpha;

      const x1 = a.x, y1 = a.y;
      const x2 = a.x + (b.x - a.x) * progress;
      const y2 = a.y + (b.y - a.y) * progress;

      const alpha = 0.18 * eqAlpha;
      if (alpha > 0.003) {
        ctx.strokeStyle = `rgba(255,255,255,${alpha})`;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }
    }

    for (let i = breakingLinks.length - 1; i >= 0; i--) {
      const link = breakingLinks[i];
      link.progress -= 0.08;
      if (link.progress <= 0) {
        breakingLinks.splice(i, 1);
        continue;
      }
      const { a, b, progress } = link;
      const eqAlpha = (link.eqAlpha === undefined) ? 1 : link.eqAlpha;
      const x1 = a.x, y1 = a.y;
      const x2 = a.x + (b.x - a.x) * progress;
      const y2 = a.y + (b.y - a.y) * progress;

      const alpha = 0.18 * eqAlpha;
      if (alpha > 0.003) {
        ctx.strokeStyle = `rgba(255,255,255,${alpha})`;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }
    }

    ctx.restore();
  }


    function computeClustersFromLinks() {
    const clusters = [];
    const linkArr = Array.from(linkMap.values());

    for (let i = 0; i < linkArr.length; i++) {
      const l = linkArr[i];
      const mx = (l.a.x + l.b.x) / 2;
      const my = (l.a.y + l.b.y) / 2;
      let placed = false;
      for (const c of clusters) {
        const dx = c.x - mx, dy = c.y - my;
        if (dx*dx + dy*dy < CLUSTER_RADIUS * CLUSTER_RADIUS) {
          c.x = (c.x * c.count + mx) / (c.count + 1);
          c.y = (c.y * c.count + my) / (c.count + 1);
          c.count++;
          c.links.push(l);
          placed = true;
          break;
        }
      }
      if (!placed) {
        clusters.push({ x: mx, y: my, count: 1, links: [l] });
      }
    }

    const now = performance.now();
    const newPrev = [];
    const prevPool = previousClusterRecords.slice();

    for (const c of clusters) {
      let matched = null;
      let matchedIndex = -1;
      for (let i = 0; i < prevPool.length; i++) {
        const p = prevPool[i];
        const d2 = (p.x - c.x)*(p.x - c.x) + (p.y - c.y)*(p.y - c.y);
        if (d2 < CLUSTER_MATCH_ID_RADIUS * CLUSTER_MATCH_ID_RADIUS) {
          matched = p;
          matchedIndex = i;
          break;
        }
      }
      if (matched) {
        c.uid = matched.uid;
        newPrev.push({ uid: matched.uid, x: c.x, y: c.y, lastSeen: now });
        prevPool.splice(matchedIndex, 1);
      } else {
        c.uid = 'c' + (nextClusterUid++);
        newPrev.push({ uid: c.uid, x: c.x, y: c.y, lastSeen: now });
      }
    }

    previousClusterRecords = newPrev;
    return clusters;
  }


  let previousClusterRecords = [];
  let nextClusterUid = 1;
  let blockAdvanceUntilInteractiveCleared = false;
  let blockAdvanceUntilCF377Ends = false;
  let blockAdvanceByInteractive = false;
  let blockAdvanceByClickblock = false;
  const CLUSTER_MATCH_ID_RADIUS = 36;
  const DUPLICATE_POS_RADIUS = 10000;
  const THOUGHT_APPEAR_DELAY = 5000;
  const thoughtPending = new Map();
  const thoughtCooldown = new Map();
  const THOUGHT_SPRING = 0.06;
  const THOUGHT_DAMPING = 0.82;
  const THOUGHT_MAX_VELOCITY = 12;


  let interactiveThoughtWasAlive = false;

function checkInteractiveThoughts() {
  const hasInteractive = activeThoughts.some(t => t.interactive && t.alive);
  blockAdvanceUntilInteractiveCleared = hasInteractive;

  if (hasInteractive) interactiveThoughtWasAlive = true;

  if (!hasInteractive && !yellowAnimationActive && !blockAdvanceUntilCF377Ends) {
    readyForClick = true;
  }

  const slide = slides[currentSlide];
  const slideHadInteractive = slide && slide.thoughts && slide.thoughts.some(t => t.interactive);

  if (!hasInteractive && slideHadInteractive && interactiveThoughtWasAlive) {
    interactiveThoughtWasAlive = false;
    blockAdvanceByInteractive = false;
    showNextSlide();
  }
}

function updateThoughtsFromClusters(clusters) {
  const now = performance.now();

  for (const key of Array.from(thoughtPending.keys())) {
    const [tplIdxStr, clusterUid] = key.split('__');
    const tplIdx = Number(tplIdxStr);
    const cluster = clusters.find(c => c.uid === clusterUid);
    const tpl = (thoughtTemplates[tplIdx] !== undefined) ? ({ ...thoughtTemplates[tplIdx], __i: tplIdx }) : null;
    if (!cluster || !tpl || cluster.count < (tpl.minLinks || 5)) {
      thoughtPending.delete(key);
    }
  }

  for (const th of activeThoughts) {
    th._matchedCluster = clusters.find(c => c.uid === th.clusterUid) || null;
  }

  const clusterObjs = clusters.map(c => ({ ...c }));
  clusterObjs.sort((a, b) => b.count - a.count);

  const templates = thoughtTemplates
    .map((tpl, i) => ({ ...tpl, __i: i }))
    .sort((a, b) => (b.minLinks || 5) - (a.minLinks || 5));

  const usedClusterUids = new Set();
  activeThoughts.forEach(t => {
    if (t.clusterUid !== undefined && clusters.find(c => c.uid === t.clusterUid)) {
      usedClusterUids.add(t.clusterUid);
    }
  });

  for (const tpl of templates) {
    const need = tpl.minLinks || 5;

    const alreadyGlobal = activeThoughts.some(at => {
      const idx = (at.template && at.template.__i !== undefined) ? at.template.__i : thoughtTemplates.indexOf(at.template);
      const clusterAlive = (at.clusterUid !== undefined) && clusters.some(c => c.uid === at.clusterUid && c.count >= need);
      return idx === tpl.__i && clusterAlive;
    });
    if (alreadyGlobal) continue;

    let chosen = null;
    for (const c of clusterObjs) {
      if (usedClusterUids.has(c.uid)) continue;
      if (c.count < need) continue;
      const key = `${tpl.__i}__${c.uid}`;
      const cd = thoughtCooldown.get(key);
      if (cd && now < cd) continue;
      const dupNearby = activeThoughts.some(at => at.text === tpl.text && Math.hypot(at.x - c.x, at.y - c.y) < DUPLICATE_POS_RADIUS);
      if (dupNearby) continue;
      chosen = c;
      break;
    }

    if (chosen) {
      const key = `${tpl.__i}__${chosen.uid}`;
      const pending = thoughtPending.get(key);
      if (!pending) {
        thoughtPending.set(key, { since: now });
        usedClusterUids.add(chosen.uid);
      } else {
        if (now - pending.since >= THOUGHT_APPEAR_DELAY) {
          const exists = activeThoughts.find(at => at.text === tpl.text && at.clusterUid === chosen.uid);
          if (!exists) {
            const th = {
              id: nextThoughtId++,
              x: chosen.x,
              y: chosen.y,
              targetX: chosen.x,
              targetY: chosen.y - 30,
              text: tpl.text,
              alpha: 0,
              alive: true,
              template: tpl,
              clusterUid: chosen.uid,
              clusterCount: chosen.count,
              _flickerOffset: Math.random() * Math.PI * 2,
              interactive: !!tpl.interactive,
              vx: 0,
              vy: 0
            };
            activeThoughts.push(th);
          }
          thoughtPending.delete(key);
          usedClusterUids.add(chosen.uid);
        } else {
          usedClusterUids.add(chosen.uid);
        }
      }
    }
  }

  for (let i = activeThoughts.length - 1; i >= 0; i--) {
    const t = activeThoughts[i];
    const c = clusters.find(c => c.uid === t.clusterUid) || null;
    const removeBelow = t.template.removeBelow !== undefined ? t.template.removeBelow : Math.max(1, (t.template.minLinks || 5) - 2);

    if (!c || c.count < removeBelow) {
      if (t.alive) {
        const tplIdx = (t.template && t.template.__i !== undefined) ? t.template.__i : thoughtTemplates.indexOf(t.template);
        if (tplIdx >= 0 && t.clusterUid !== undefined) {
          const key = `${tplIdx}__${t.clusterUid}`;
          thoughtCooldown.set(key, now + THOUGHT_APPEAR_DELAY);
        }
      }
      t.alive = false;
    } else {
      t.clusterCount = c.count;
      t.targetX = c.x;
      t.targetY = c.y - 30;
      t.alpha += (1 - t.alpha) * 0.12;
      t.x += (t.targetX - t.x) * 0.14;
      t.y += (t.targetY - t.y) * 0.14;
    }

    if (!t.alive) {
      t.alpha *= 0.86;
      if (t.alpha < 0.02) {
        activeThoughts.splice(i, 1);
      }
    }
  }
  checkInteractiveThoughts();
}


  function drawThoughts() {
    const now = performance.now();
    for (const t of activeThoughts) {
      const flicker = 0.50 + 0.20 * Math.sin(now / 1000 + (t._flickerOffset || 0));
      const alpha = Math.max(0, Math.min(1, t.alpha * flicker));

      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.font = "14px 'Courier New', monospace";
      ctx.textBaseline = 'top';

      const metrics = ctx.measureText(t.text);
      const textW = metrics.width;
      let x = t.x - textW / 2;
      let y = t.y - 22;

      if (x < 6) x = 6;
      if (x + textW > canvas.width - 6) x = canvas.width - textW - 6;
      if (y < 6) y = t.y + 10;

      if (t.interactive) {
        ctx.fillStyle = "#ffe066";
        let offsetX = x;
        for (let i = 0; i < t.text.length; i++) {
          const ch = t.text[i];
          const dx = (Math.random() - 0.5) * 1.2;
          const dy = (Math.random() - 0.5) * 1.2;
          ctx.save();
          ctx.shadowColor = "#ffe066";
          ctx.shadowBlur = 6;
          ctx.fillText(ch, offsetX + dx, y + dy);
          ctx.restore();
          offsetX += ctx.measureText(ch).width + 0.5;
        }
      } else {
        ctx.fillStyle = "rgba(255,255,255,1)";
        ctx.fillText(t.text, x, y);
      }
      ctx.restore();
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke) {
    if (typeof r === 'undefined') r = 5;
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function updateThoughtPositions() {
    for (const t of activeThoughts) {
      if (t.targetX === undefined || t.targetY === undefined) continue;

      const dx = t.targetX - t.x;
      const dy = t.targetY - t.y;

      t.vx += dx * THOUGHT_SPRING;
      t.vy += dy * THOUGHT_SPRING;

      const speed = Math.hypot(t.vx, t.vy);
      if (speed > THOUGHT_MAX_VELOCITY) {
        t.vx = (t.vx / speed) * THOUGHT_MAX_VELOCITY;
        t.vy = (t.vy / speed) * THOUGHT_MAX_VELOCITY;
      }

      t.vx *= THOUGHT_DAMPING;
      t.vy *= THOUGHT_DAMPING;

      t.x += t.vx;
      t.y += t.vy;

      if (Math.abs(dx) < 0.5 && Math.abs(dy) < 0.5) {
        t.vx *= 0.6;
        t.vy *= 0.6;
      }
    }
  }


  function animateParticles(time = 0) {
  frameCount++;
  activeRects = Array.from(document.querySelectorAll('.slide.active, .slide.out')).map(el => el.getBoundingClientRect());

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (frameCount % LINK_UPDATE_PERIOD === 0) {
    updateLinks(time);
  }
  
  drawLinks();

  for (let p of particles) {
    p.update(time);
    p.draw();
  }

  if (frameCount % CLUSTER_UPDATE_PERIOD === 0) {
    const clusters = computeClustersFromLinks();
    updateThoughtsFromClusters(clusters);
  }
  updateThoughtPositions();
  drawThoughts();

  if (typeof updateAndDrawThoughtFragments === 'function') updateAndDrawThoughtFragments(ctx);


  requestAnimationFrame(animateParticles);
}


  animateParticles();

  function resetParticleHomes() {
  particles.forEach(p => {
    p.homeX = Math.random() * canvas.width;
    p.homeY = Math.random() * canvas.height;
    p.nearTimes = {};
    if (!isFinite(p.x) || !isFinite(p.y)) { p.x = p.homeX; p.y = p.homeY; }
  });
}

  function applySlideThoughtTemplates(slide) {
    if (!slide || !slide.thoughts) {
      thoughtTemplates = [];
      activeThoughts = [];
      return;
    }

    thoughtTemplates = slide.thoughts.map(t => ({
      text: t.text || '',
      minLinks: t.minLinks || 5,
      removeBelow: (t.removeBelow !== undefined) ? t.removeBelow : Math.max(1, (t.minLinks || 5) - 2),
      interactive: !!t.interactive
    }));

    activeThoughts = [];
  }

  const cfAudio = audioMap.CF377;
  if (cfAudio) {
    cfAudio.addEventListener('playing', () => {
      blockAdvanceUntilCF377Ends = true;
      readyForClick = false;
    });
    cfAudio.addEventListener('ended', () => {
      blockAdvanceUntilCF377Ends = false;
      readyForClick = true;
    });
  }



  const SLIDE_ADVANCE_DEBOUNCE = 300;
  let __lastSlideAdvance = 0;

  if (typeof window.showNextSlide === 'function') {
    const _origShow = window.showNextSlide;
    window.showNextSlide = function(...args) {
      const now = performance.now();
      if (now - __lastSlideAdvance < SLIDE_ADVANCE_DEBOUNCE) {
        return;
      }
      __lastSlideAdvance = now;

      const res = _origShow.apply(this, args);

      const s = slides[currentSlide];
      try {
        applySlideThoughtTemplates(s);
      } catch (err) { console.warn("applySlideThoughtTemplates error:", err); }

      if (s?.play && s.play.includes('CF377')) {
        blockAdvanceUntilCF377Ends = true;
        readyForClick = false;
        try {
          const a = audioMap.CF377;
          if (a && !a.paused) {
          } else if (a && a.paused) {
          }
        } catch (e) {}
      } else {
        if (!yellowAnimationActive) readyForClick = true;
      }

      return res;
    };
  } else {
    window.showNextSlide = function() {
      const now = performance.now();
      if (now - __lastSlideAdvance < SLIDE_ADVANCE_DEBOUNCE) return;
      __lastSlideAdvance = now;
    };
  }

  const mo = new MutationObserver(mutations => {
    for (const m of mutations) {
      if (m.type === 'attributes' && m.attributeName === 'class') {
        const active = document.querySelector('.slide.active');
        if (active) {
          const idx = Array.from(slidesElements).indexOf(active);
          if (idx >= 0 && slides[idx]) {
            applySlideThoughtTemplates(slides[idx]);
            if (slides[idx].play && slides[idx].play.includes('CF377')) {
              blockAdvanceUntilCF377Ends = true;
              readyForClick = false;
            } else {
              if (!yellowAnimationActive) readyForClick = true;
            }
          }
        }
      }
    }
  });
  mo.observe(container, { attributes: true, subtree: true, attributeFilter: ['class'] });

</script>



</body>
</html>

